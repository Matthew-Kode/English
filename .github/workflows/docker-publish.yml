name: Build and Push PersonaPlex

on:
  push:
    branches: [ "main" ]

env:
  # Use docker.io for Docker Hub if empty
  REGISTRY: docker.io
  # github.repository as <account>/<repo>
  IMAGE_NAME: matthewkode/personaplex

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Login to Docker Hub
      - name: Log into registry ${{ env.REGISTRY }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Verify Docker Auth (Fail fast if credentials are invalid)
      - name: Verify Docker Auth
        run: |
          echo "üîê Verifying Docker Hub credentials.."
          docker pull hello-world
          echo "‚úÖ Docker Hub auth is working!"

      # Set up Docker Buildx (Essential for caching and multi-platform)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Verify HF Token (Debug Step)
      - name: Verify HF Token
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          pip install huggingface_hub
          python -c "import os; t = os.environ.get('HF_TOKEN', ''); print(f'Token Length: {len(t)}'); from huggingface_hub import HfApi; print('User:', HfApi(token=t).whoami()['name'])"

      # Build and Push
      # Note: We pass the HF_TOKEN from GitHub Secrets to the Docker Build Args
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: personaplex-main/Dockerfile
          push: true
          tags: ${{ env.IMAGE_NAME }}:v4
          build-args: |
            HF_TOKEN=${{ secrets.HF_TOKEN }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
